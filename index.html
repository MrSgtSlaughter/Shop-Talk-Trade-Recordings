<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Local 449 Admin Dashboard</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);
      min-height: 100vh;
    }
    .login-container { display:flex; justify-content:center; align-items:center; min-height:100vh; padding:20px; }
    .login-box {
      background:white; padding:40px; border-radius:15px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      max-width: 420px; width:100%;
    }
    .login-box h1 { color:#FFB612; margin-bottom:10px; font-size:2em; }
    .login-box p { color:#666; margin-bottom:30px; }
    .form-group { margin-bottom:18px; }
    .form-group label { display:block; color:#333; font-weight:600; margin-bottom:8px; }
    .form-group input {
      width:100%; padding:12px; border:2px solid #ddd; border-radius:8px; font-size:1em;
    }
    .form-group input:focus { outline:none; border-color:#FFB612; }
    .btn {
      width:100%; padding:14px; border:none; border-radius:8px;
      font-size:1em; font-weight:bold; cursor:pointer; transition: all 0.2s;
    }
    .btn-primary { background: linear-gradient(45deg, #FFB612, #D4AF37); color:#000; }
    .btn-primary:hover { transform: translateY(-1px); box-shadow:0 5px 15px rgba(255,182,18,0.35); }
    .btn-primary:disabled { opacity:0.6; cursor:not-allowed; transform:none; box-shadow:none; }

    .error-box {
      margin-top: 14px;
      background: #fff1f0;
      border: 1px solid #ffccc7;
      color: #a8071a;
      padding: 12px;
      border-radius: 8px;
      display: none;
      line-height: 1.35;
      font-size: 0.95em;
    }

    .dashboard { display:none; }
    .dashboard.active { display:block; }
    .header {
      background: linear-gradient(135deg, #000 0%, #222 100%);
      color:#FFB612;
      padding: 20px 40px;
      display:flex; justify-content:space-between; align-items:center;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      gap: 12px;
      flex-wrap: wrap;
    }
    .header h1 { font-size:1.6em; }
    .header-right { display:flex; gap:20px; align-items:center; flex-wrap: wrap; }
    .user-info { color:#FFB612; }
    .btn-logout {
      background:#e74c3c; color:white; padding:10px 20px;
      border:none; border-radius:6px; cursor:pointer; font-weight:600;
    }
    .btn-logout:hover { background:#c0392b; }

    .content { max-width: 1400px; margin:0 auto; padding: 40px 20px; }
    .stats {
      display:grid; grid-template-columns: repeat(auto-fit, minmax(200px,1fr));
      gap:20px; margin-bottom:30px;
    }
    .stat-card {
      background:white; padding:25px; border-radius:12px;
      box-shadow:0 4px 15px rgba(0,0,0,0.05); text-align:center;
    }
    .stat-number { font-size:2.5em; font-weight:bold; color:#FFB612; }
    .stat-label { color:#666; font-size:0.95em; margin-top:5px; }

    .filters {
      background:white; padding:25px; border-radius:12px; margin-bottom:30px;
      box-shadow:0 4px 15px rgba(0,0,0,0.05);
    }
    .filters h2 { color:#FFB612; margin-bottom:20px; font-size:1.4em; }
    .filter-grid {
      display:grid; grid-template-columns: repeat(auto-fit, minmax(200px,1fr));
      gap:15px; margin-bottom:15px;
    }
    .filter-grid input, .filter-grid select {
      padding:10px; border:2px solid #ddd; border-radius:6px; font-size:0.95em;
    }

    .recordings-list {
      background:white; border-radius:12px;
      box-shadow:0 4px 15px rgba(0,0,0,0.05);
      overflow:hidden;
    }
    .recording-item { padding:25px; border-bottom:1px solid #eee; transition: background 0.2s; }
    .recording-item:hover { background:#f9f9f9; }
    .recording-item:last-child { border-bottom:none; }

    .recording-header { display:flex; justify-content:space-between; align-items:start; margin-bottom:15px; flex-wrap: wrap; gap:15px; }
    .recording-title { font-size:1.3em; font-weight:600; color:#333; }
    .recording-meta { display:flex; gap:20px; flex-wrap:wrap; margin-bottom:15px; color:#666; font-size:0.9em; }
    .recording-meta span { display:flex; align-items:center; gap:5px; }

    .audio-player { width:100%; margin: 15px 0; }

    .recording-actions { display:flex; gap:10px; flex-wrap:wrap; }
    .btn-small {
      padding:8px 16px; border:none; border-radius:6px;
      font-size:0.9em; font-weight:600; cursor:pointer; transition: all 0.2s;
    }
    .btn-transcribe { background:#3498db; color:white; }
    .btn-transcribe:hover { background:#2980b9; }
    .btn-transcribe:disabled { background:#95a5a6; cursor:not-allowed; }
    .btn-summarize { background:#9b59b6; color:white; }
    .btn-summarize:hover { background:#8e44ad; }
    .btn-delete { background:#e74c3c; color:white; }
    .btn-delete:hover { background:#c0392b; }

    .transcript-box, .summary-box {
      background:#f8f9fa; border-left:4px solid #FFB612;
      padding:20px; margin-top:15px; border-radius:6px; display:none;
    }
    .transcript-box.active, .summary-box.active { display:block; }
    .transcript-box h4, .summary-box h4 { color:#FFB612; margin-bottom:10px; }
    .transcript-text, .summary-text { line-height:1.6; color:#333; white-space:pre-wrap; }

    .loading { text-align:center; padding:40px; color:#666; }
    .empty-state { text-align:center; padding:60px 20px; color:#666; }
    .empty-state-icon { font-size:4em; margin-bottom:20px; }

    .status-badge { padding:4px 12px; border-radius:12px; font-size:0.85em; font-weight:600; }
    .status-new { background:#e8f5e8; color:#2ecc71; }
    .status-completed { background:#f0e8f5; color:#9b59b6; }

    @media (max-width: 768px) {
      .header { flex-direction:column; text-align:center; }
      .filter-grid { grid-template-columns: 1fr; }
      .recording-header { flex-direction: column; }
    }
  </style>
</head>
<body>
  <div id="loginPage" class="login-container">
    <div class="login-box">
      <h1>LOCAL 449</h1>
      <p>Admin Dashboard - Instructor Recordings</p>

      <form id="loginForm">
        <div class="form-group">
          <label for="email">Email</label>
          <input type="email" id="email" placeholder="admin@local449.org" required />
        </div>

        <div class="form-group">
          <label for="password">Password</label>
          <input type="password" id="password" placeholder="Enter password" required />
        </div>

        <button id="loginBtn" type="submit" class="btn btn-primary">Sign In</button>

        <div id="loginError" class="error-box"></div>
      </form>
    </div>
  </div>

  <div id="dashboardPage" class="dashboard">
    <div class="header">
      <h1>üìä Instructor Recordings Dashboard</h1>
      <div class="header-right">
        <div class="user-info">
          <strong id="userEmail"></strong>
        </div>
        <button class="btn-logout" id="logoutBtn">Sign Out</button>
      </div>
    </div>

    <div class="content">
      <div class="stats">
        <div class="stat-card">
          <div class="stat-number" id="totalRecordings">0</div>
          <div class="stat-label">Total Recordings</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="totalInstructors">0</div>
          <div class="stat-label">Instructors</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="totalDuration">0h</div>
          <div class="stat-label">Total Duration</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="thisWeek">0</div>
          <div class="stat-label">This Week</div>
        </div>
      </div>

      <div class="filters">
        <h2>üîç Filter Recordings</h2>
        <div class="filter-grid">
          <input type="text" id="filterInstructor" placeholder="Filter by instructor..." />
          <input type="text" id="filterGroup" placeholder="Filter by group..." />
          <input type="text" id="filterCourse" placeholder="Filter by course..." />
          <select id="filterSort">
            <option value="newest">Newest First</option>
            <option value="oldest">Oldest First</option>
            <option value="longest">Longest Duration</option>
            <option value="shortest">Shortest Duration</option>
          </select>
        </div>
        <button class="btn btn-primary" style="margin-top:15px;" id="applyFiltersBtn">Apply Filters</button>
      </div>

      <div class="recordings-list" id="recordingsList">
        <div class="loading">Loading recordings...</div>
      </div>
    </div>
  </div>

  <!-- PINNED, STABLE UMD BUILD (prevents CDN surprises) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.49.1/dist/umd/supabase.min.js"></script>

  <script>
    // =========================
    // Supabase Configuration
    // =========================
    const SUPABASE_URL = 'https://dfneumnqaxfdmtkzqezm.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRmbmV1bW5xYXhmZG10a3pxZXptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwOTUyNDksImV4cCI6MjA3NTY3MTI0OX0.XM-zDV1Ne8izUJFDGR6_6jRa5HHqCPc9Jho9f5YsGNM';

    // IMPORTANT: v2 createClient with explicit auth persistence
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: true,
        storage: window.localStorage
      }
    });

    const ui = {
      loginPage: document.getElementById('loginPage'),
      dashboardPage: document.getElementById('dashboardPage'),
      loginForm: document.getElementById('loginForm'),
      loginBtn: document.getElementById('loginBtn'),
      loginError: document.getElementById('loginError'),
      logoutBtn: document.getElementById('logoutBtn'),
      userEmail: document.getElementById('userEmail'),
      recordingsList: document.getElementById('recordingsList'),
      applyFiltersBtn: document.getElementById('applyFiltersBtn')
    };

    function showLoginError(msg) {
      ui.loginError.style.display = 'block';
      ui.loginError.textContent = msg;
    }
    function clearLoginError() {
      ui.loginError.style.display = 'none';
      ui.loginError.textContent = '';
    }

    const dashboard = {
      currentUser: null,
      recordings: [],
      filteredRecordings: [],
      filterTimeout: null,

      async init() {
        // 1) Listen for auth changes (THIS prevents the ‚Äúlogin loop‚Äù)
        supabase.auth.onAuthStateChange((_event, session) => {
          if (session?.user) {
            this.currentUser = session.user;
            this.showDashboard();
          } else {
            this.currentUser = null;
            this.showLogin();
          }
        });

        // 2) On page load, check for existing session
        const { data: { session } } = await supabase.auth.getSession();
        if (session?.user) {
          this.currentUser = session.user;
          await this.showDashboard();
        } else {
          this.showLogin();
        }

        // Login submit
        ui.loginForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          await this.login();
        });

        // Logout
        ui.logoutBtn.addEventListener('click', async () => {
          await this.logout();
        });

        // Filters
        ['filterInstructor', 'filterGroup', 'filterCourse'].forEach(id => {
          document.getElementById(id).addEventListener('input', () => {
            clearTimeout(this.filterTimeout);
            this.filterTimeout = setTimeout(() => this.applyFilters(), 250);
          });
        });
        document.getElementById('filterSort').addEventListener('change', () => this.applyFilters());
        ui.applyFiltersBtn.addEventListener('click', () => this.applyFilters());
      },

      showLogin() {
        ui.loginPage.style.display = 'flex';
        ui.dashboardPage.classList.remove('active');
      },

      async login() {
        clearLoginError();
        ui.loginBtn.disabled = true;
        ui.loginBtn.textContent = 'Signing in...';

        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;

        try {
          const { data, error } = await supabase.auth.signInWithPassword({ email, password });
          if (error) throw error;

          // onAuthStateChange will handle showing the dashboard,
          // but we also set currentUser here for immediate UI.
          this.currentUser = data.user;

        } catch (err) {
          showLoginError('Login failed: ' + (err?.message || String(err)));
        } finally {
          ui.loginBtn.disabled = false;
          ui.loginBtn.textContent = 'Sign In';
        }
      },

      async logout() {
        await supabase.auth.signOut();
        this.currentUser = null;
        this.showLogin();
      },

      async showDashboard() {
        if (!this.currentUser) return;

        ui.loginPage.style.display = 'none';
        ui.dashboardPage.classList.add('active');
        ui.userEmail.textContent = this.currentUser.email;

        await this.loadRecordings();
      },

      async loadRecordings() {
        ui.recordingsList.innerHTML = '<div class="loading">Loading recordings...</div>';

        try {
          const { data, error } = await supabase
            .from('instructor_recordings')
            .select('*')
            .order('recorded_at', { ascending: false });

          if (error) throw error;

          this.recordings = data || [];
          this.filteredRecordings = [...this.recordings];
          this.updateStats();
          this.renderRecordings();

        } catch (error) {
          console.error('Error loading recordings:', error);
          ui.recordingsList.innerHTML =
            '<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><h2>Error Loading Recordings</h2><p>' +
            (error?.message || String(error)) + '</p></div>';
        }
      },

      updateStats() {
        const totalRecordings = this.recordings.length;
        const uniqueInstructors = new Set(this.recordings.map(r => r.instructor_name)).size;
        const totalSeconds = this.recordings.reduce((sum, r) => sum + (r.duration_seconds || 0), 0);
        const totalHours = Math.round((totalSeconds / 3600) * 10) / 10;

        const oneWeekAgo = new Date();
        oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
        const thisWeek = this.recordings.filter(r => new Date(r.recorded_at) > oneWeekAgo).length;

        document.getElementById('totalRecordings').textContent = totalRecordings;
        document.getElementById('totalInstructors').textContent = uniqueInstructors;
        document.getElementById('totalDuration').textContent = totalHours + 'h';
        document.getElementById('thisWeek').textContent = thisWeek;
      },

      applyFilters() {
        const instructorFilter = document.getElementById('filterInstructor').value.toLowerCase();
        const groupFilter = document.getElementById('filterGroup').value.toLowerCase();
        const courseFilter = document.getElementById('filterCourse').value.toLowerCase();
        const sortBy = document.getElementById('filterSort').value;

        this.filteredRecordings = this.recordings.filter(r => {
          return (r.instructor_name || '').toLowerCase().includes(instructorFilter) &&
                 (r.apprentice_group || '').toLowerCase().includes(groupFilter) &&
                 (r.course_name || '').toLowerCase().includes(courseFilter);
        });

        this.filteredRecordings.sort((a, b) => {
          switch (sortBy) {
            case 'newest': return new Date(b.recorded_at) - new Date(a.recorded_at);
            case 'oldest': return new Date(a.recorded_at) - new Date(b.recorded_at);
            case 'longest': return (b.duration_seconds || 0) - (a.duration_seconds || 0);
            case 'shortest': return (a.duration_seconds || 0) - (b.duration_seconds || 0);
            default: return 0;
          }
        });

        this.renderRecordings();
      },

      renderRecordings() {
        const container = ui.recordingsList;

        if (this.filteredRecordings.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üé§</div>
              <h2>No Recordings Found</h2>
              <p>No recordings match your filters, or none have been uploaded yet.</p>
            </div>`;
          return;
        }

        container.innerHTML = this.filteredRecordings.map((recording) => {
          const date = new Date(recording.recorded_at);
          const duration = this.formatDuration(recording.duration_seconds || 0);
          const fileSize = this.formatFileSize(recording.file_size || 0);
          const hasTranscript = recording.transcript && recording.transcript.length > 0;
          const hasSummary = recording.summary && recording.summary.length > 0;

          return `
            <div class="recording-item" id="recording-${recording.id}">
              <div class="recording-header">
                <div>
                  <div class="recording-title">${this.escapeHtml(recording.course_name || '(No course name)')}</div>
                  <span class="status-badge ${hasTranscript ? 'status-completed' : 'status-new'}">
                    ${hasTranscript ? 'Transcribed' : 'New'}
                  </span>
                </div>
              </div>

              <div class="recording-meta">
                <span>üë§ ${this.escapeHtml(recording.instructor_name || '')}</span>
                <span>üë• ${this.escapeHtml(recording.apprentice_group || '')}</span>
                <span>üìÖ ${date.toLocaleDateString()} ${date.toLocaleTimeString()}</span>
                <span>‚è±Ô∏è ${duration}</span>
                <span>üíæ ${fileSize}</span>
              </div>

              <audio class="audio-player" controls>
                <source src="${recording.recording_url}" type="audio/webm" />
                Your browser does not support the audio element.
              </audio>

              <div class="recording-actions">
                <button class="btn-small btn-transcribe" id="transcribe-btn-${recording.id}"
                  onclick="dashboard.transcribe(${recording.id})">
                  ${hasTranscript ? 'üìù View Transcript' : 'üìù Generate Transcript'}
                </button>

                <button class="btn-small btn-summarize" id="summarize-btn-${recording.id}"
                  onclick="dashboard.summarize(${recording.id})" ${!hasTranscript ? 'disabled' : ''}>
                  ${hasSummary ? 'üìã View Summary' : 'üìã Generate Summary'}
                </button>

                <button class="btn-small btn-delete" onclick="dashboard.deleteRecording(${recording.id})">
                  üóëÔ∏è Delete
                </button>
              </div>

              <div class="transcript-box" id="transcript-${recording.id}">
                <h4>üìù Transcript</h4>
                <div class="transcript-text" id="transcript-text-${recording.id}">
                  ${hasTranscript ? this.escapeHtml(recording.transcript) : 'No transcript yet.'}
                </div>
              </div>

              <div class="summary-box" id="summary-${recording.id}">
                <h4>üìã Summary</h4>
                <div class="summary-text" id="summary-text-${recording.id}">
                  ${hasSummary ? this.escapeHtml(recording.summary) : 'No summary yet.'}
                </div>
              </div>
            </div>
          `;
        }).join('');
      },

      toggleBox(boxId) {
        const el = document.getElementById(boxId);
        el.classList.toggle('active');
      },

      formatDuration(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
      },

      formatFileSize(bytes) {
        const mb = bytes / (1024 * 1024);
        return mb.toFixed(1) + ' MB';
      },

      escapeHtml(str) {
        return String(str ?? '')
          .replaceAll('&', '&amp;')
          .replaceAll('<', '&lt;')
          .replaceAll('>', '&gt;')
          .replaceAll('"', '&quot;')
          .replaceAll("'", '&#039;');
      },

      async transcribe(recordingId) {
        const recording = this.recordings.find(r => r.id === recordingId);
        if (!recording) return;

        const transcriptBox = document.getElementById(`transcript-${recordingId}`);
        const transcriptText = document.getElementById(`transcript-text-${recordingId}`);
        const btn = document.getElementById(`transcribe-btn-${recordingId}`);

        // If transcript already exists, just show/hide it
        if (recording.transcript && recording.transcript.length > 0) {
          transcriptBox.classList.toggle('active');
          return;
        }

        transcriptBox.classList.add('active');
        btn.disabled = true;
        btn.textContent = '‚è≥ Transcribing...';
        transcriptText.textContent = 'Submitting audio to AssemblyAI (secure)‚Ä¶';

        try {
          // Call your Supabase Edge Function (keeps your AssemblyAI key private)
          const start = await supabase.functions.invoke('assemblyai', {
            body: { action: 'start', audio_url: recording.recording_url }
          });

          if (start.error) throw start.error;
          const transcriptId = start.data?.id;
          if (!transcriptId) throw new Error('No transcript id returned');

          transcriptText.textContent = 'Transcription in progress...';

          // Poll the Edge Function for status
          const transcript = await this.pollTranscription(transcriptId, transcriptText);

          // Save to DB
          const { error: updateErr } = await supabase
            .from('instructor_recordings')
            .update({ transcript: transcript.text, status: 'transcribed' })
            .eq('id', recordingId);

          if (updateErr) throw updateErr;

          recording.transcript = transcript.text;
          transcriptText.textContent = transcript.text;

          btn.textContent = 'üìù View Transcript';
          btn.disabled = false;

          // Enable summary button
          document.getElementById(`summarize-btn-${recordingId}`).disabled = false;

        } catch (error) {
          console.error('Transcription error:', error);
          transcriptText.textContent = '‚ùå Transcription failed: ' + (error?.message || String(error));
          btn.disabled = false;
          btn.textContent = 'üìù Retry Transcript';
        }
      },

      async pollTranscription(transcriptId, statusElement) {
        const maxAttempts = 60;
        let attempts = 0;

        while (attempts < maxAttempts) {
          const res = await supabase.functions.invoke('assemblyai', {
            body: { action: 'status', id: transcriptId }
          });

          if (res.error) throw res.error;

          const data = res.data;
          if (!data) throw new Error('No status response from function');

          if (data.status === 'completed') return data;
          if (data.status === 'error') throw new Error(data.error || 'AssemblyAI error');

          statusElement.textContent = `Transcribing... (${attempts + 1}/${maxAttempts})`;
          await new Promise(r => setTimeout(r, 5000));
          attempts++;
        }

        throw new Error('Transcription timed out');
      },

      async summarize(recordingId) {
        const recording = this.recordings.find(r => r.id === recordingId);
        if (!recording) return;

        const summaryBox = document.getElementById(`summary-${recordingId}`);
        const summaryText = document.getElementById(`summary-text-${recordingId}`);
        const btn = document.getElementById(`summarize-btn-${recordingId}`);

        // If summary exists, toggle display
        if (recording.summary && recording.summary.length > 0) {
          summaryBox.classList.toggle('active');
          return;
        }

        if (!recording.transcript) {
          alert('Generate a transcript first!');
          return;
        }

        summaryBox.classList.add('active');
        btn.disabled = true;
        btn.textContent = '‚è≥ Summarizing...';
        summaryText.textContent = 'Generating summary...';

        try {
          const summary = await this.generateAISummary(recording.transcript);

          const { error: updateErr } = await supabase
            .from('instructor_recordings')
            .update({ summary })
            .eq('id', recordingId);

          if (updateErr) throw updateErr;

          recording.summary = summary;
          summaryText.textContent = summary;

          btn.textContent = 'üìã View Summary';
          btn.disabled = false;

        } catch (error) {
          console.error('Summary error:', error);
          summaryText.textContent = '‚ùå Summary failed: ' + (error?.message || String(error));
          btn.disabled = false;
          btn.textContent = 'üìã Retry Summary';
        }
      },

      async generateAISummary(transcript) {
        const sentences = transcript.match(/[^.!?]+[.!?]+/g) || [];
        const wordCount = transcript.split(/\s+/).filter(Boolean).length;
        const estimatedMinutes = Math.round(wordCount / 150);

        const words = transcript.toLowerCase()
          .replace(/[^a-z\s]/g, '')
          .split(/\s+/)
          .filter(w => w.length > 4);

        const stopWords = new Set([
          'there','their','would','could','should','about','these','those','through',
          'where','which','while','thing','right','going','really','think'
        ]);

        const freq = {};
        for (const w of words) {
          if (!stopWords.has(w)) freq[w] = (freq[w] || 0) + 1;
        }

        const topKeywords = Object.entries(freq)
          .sort((a,b) => b[1]-a[1])
          .slice(0,10)
          .map(([w]) => w);

        const questions = sentences.filter(s => s.includes('?'));

        let summary = `üìä LECTURE SUMMARY\n${'='.repeat(50)}\n\n`;
        summary += `üìà STATISTICS:\n`;
        summary += `‚Ä¢ Total Words: ${wordCount.toLocaleString()}\n`;
        summary += `‚Ä¢ Sentences: ${sentences.length}\n`;
        summary += `‚Ä¢ Estimated Speaking Time: ${estimatedMinutes} minutes\n`;
        summary += `‚Ä¢ Questions/Discussions: ${questions.length}\n\n`;

        summary += `üîë KEY TOPICS COVERED:\n`;
        topKeywords.forEach((k, i) => summary += `${i+1}. ${k.charAt(0).toUpperCase() + k.slice(1)}\n`);
        summary += `\n`;

        if (questions.length > 0) {
          summary += `‚ùì QUESTIONS:\n`;
          questions.slice(0,3).forEach((q,i) => summary += `${i+1}. ${q.trim()}\n`);
          if (questions.length > 3) summary += `... and ${questions.length - 3} more\n`;
          summary += `\n`;
        }

        summary += `üìù CONTENT PREVIEW:\n`;
        summary += (sentences.slice(0,5).join(' ') + (sentences.length > 5 ? '...' : '')) + `\n\n`;
        summary += `${'='.repeat(50)}\n`;

        return summary;
      },

      async deleteRecording(recordingId) {
        if (!confirm('Delete this recording permanently?')) return;

        try {
          const recording = this.recordings.find(r => r.id === recordingId);
          if (!recording) return;

          // Delete file from storage (if filename is stored)
          if (recording.filename) {
            const { error: storageErr } = await supabase.storage
              .from('recordings')
              .remove([recording.filename]);
            if (storageErr) throw storageErr;
          }

          // Delete row
          const { error: dbErr } = await supabase
            .from('instructor_recordings')
            .delete()
            .eq('id', recordingId);

          if (dbErr) throw dbErr;

          await this.loadRecordings();

        } catch (error) {
          alert('Delete failed: ' + (error?.message || String(error)));
        }
      }
    };

    // Make dashboard available to onclick handlers
    window.dashboard = dashboard;

    document.addEventListener('DOMContentLoaded', () => dashboard.init());
  </script>
</body>
</html>
